<script type="application/javascript">
  //Consts
  const EXP_SHEET_CUSTOM = "custom";
  const EXP_SHEET_SINGLE = "currentSheet";
  const EXP_TYPE_XML = "xmlFormat";
  //General
  const IGNORE_COLUMN_DEFAULT = "NOEX_";
  const UNWRAP_SHEETS_DEFAULT = "US_";
  const COLLAPSE_SHEET_DEFAULT = "CS_";
  //XML
  const XML_ROOT_DEFAULT = "data";
  const XML_ATT_DEFAULT = "ATT_";
  const XML_CE_DEFAULT = "CE_";
  const XML_IT_DEFAULT = "IT_";
  //JSON
  const JSON_SEPARATOR_DEFAULT = ","; //TODO: Cannot be " or ' chars
  const JSON_JA_DEFAULT = "JA_";
  //Nesting Elements
  const NEST_NA_DEFAULT = "NA_";
  
  //Visualization
  var visualizeData = false;
  
  //Format options
  //The format to export data as
  var exportType = "jsonFormat";
  //Determines what sheets to export data from
  var exportSheets = "allSheets";
  //Specific sheets to export data from
  var targetSheets = { };
  var sheets = new Array();
  //Determines the export location
  var exportFolderType = "default";
  //The folder to export files to
  var exportFolder = "";
  
  //General Options
  //Replaces any export files that have the same name
  var replaceExistingFiles = false;
  //Don't wrap the contents of a sheet in a JSON object / XML element if the sheet only has one row
  var unwrapSingleRows = false;
  //Collapse the contents of a sheet in a JSON object / XML element if the sheet only has one row
  var collapseSingleRows = false;
  //Don't export cells that are empty (helps reduce file size)
  var ignoreEmptyCells = false;
  //Include the first column in the export in addition to using it as the name for the row element.
  var includeFirstColumn = false;
  
  //Advanced Options
  //Support complex nested elements by using special key formatting
  var nestedElements = false;
  //Export data without spaces or newlines
  var minifyData = false;
  //Don't export columns with the ignore prefix
  var ignoreColumnsWithPrefix = false;
  var ignoreColumnsPrefix = "NOEX_";
  //Unwrap sheets with this prefix
  var unwrapSheetsWithPrefix = false;
  var unwrapSheetsPrefix = "US_";
  //Collapse sheets with one row and this prefix
  var collapseSheetsWithPrefix = false;
  var collapseSheetsPrefix = "CS_";
  
  //XML Options
  //Export values as child elements instead of attributes
  var exportChildElementXml = false;
  //Export boolean values as "1" or "0" instead of "true" or "false" respectively.
  var exportBoolsAsIntsXml = false;
  
  //XML Advanced Options
  //Root element of the XML document
  var rootElementXml = "data";
  //XML element name invalid char replacement
  var nameReplacementCharXml = "_";
  //XML declaration inclusion
  var includeDeclarationXml = false;
  //XML declaration version
  var declarationVersionXml = "1.0";
  //XML declaration encoding
  var declarationEncodingXml = "none";
  //XML declaration standalone
  var declarationStandaloneXml = "none";
  //Columns using keys starting with a specified string will always be exported as attributes
  var forceAttributesXml = false;
  var forceAttributesPrefixXml = "ATT_";
  //Columns using keys starting with a specified string will always be exported as child elements
  var forceChildElementsXml = false;
  var forceChildElementsPrefixXml = "CE_";
  //Columns using keys starting with a specified string will always be exported as inner text
  var forceInnerTextXml = false;
  var forceInnerTextPrefixXml = "IT_";
  
  //JSON Options
  //Export cell contents as a JSON array if the cell contains commas
  var exportCellArrayJson = false;
  //Export a sheet's contents as an array, with each row being one JSON object element in the array
  var exportSheetArrayJson = false;
  //Export a sheet's contents as an array of values if the sheet contains only one column
  var exportValueArrayJson = false;
  //Force every value to be a string instead of the default bool/int/float/etc.
  var forceStringJson = false;
  
  //JSON Advanced Options
  //Export the spreadsheet's contents as a JSON array, instead of a regular JSON object
  var exportContentsAsArrayJson = false;
  //Export cell contents as a JSON object if the cell is wrapped with {}
  var exportCellObjectJson = false;
  //Export sheets as 2D JSON arrays
  var export2dArrayJson = false;
  //Value to export empty cells as, null (null) or empty string ("")
  var emptyValueFormatJson = "null";
  //Value to export null strings as, null (null) or string ("null")
  var nullValueFormatJson = "null";
  //Separator char for JSON arrays
  var arraySeparatorCharJson = ",";
  //Sheets or columns using keys starting with a specified string will always be exported as JSON arrays
  var forceArrayJson = false;
  var forceArrayPrefixJson = "JA_";
  //Sheets using the specified prefix will always be exported as nested arrays
  var forceArrayNest = false;
  var forceArrayPrefixNest = "NAR_";
  
  //Get the properties for the sheet to automatically set values based on the user's last export for this document.
  function getProperties(onSuccess, onFailure)
  {
    return google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).getExportProperties();
  }
  
  //Saves the properties for the user's last export for this document so they are automatically set the next time the document opens..
  function setProperties()
  {
    return google.script.run.withFailureHandler(onSetPropertiesFailure).setExportProperties(generateProperties());
  }
  
  //Safety check in case getting properties throws an error. This can occur due to a bug on Google's side of Apps Script execution that involves multiple accounts being signed in.
  function onGetPropertiesFailure(error)
  {
    google.script.run.openErrorModal("Settings Error", 
      "There was an error retrieving user settings, so default settings have been loaded. This is most often due to multiple accounts being signed in.", 
      error.message + "\n" + error.stack);
      
    //Open the sidebar with default values.
    updateProperties(null);
  }
  
  //Safety check in case setting properties throws an error. This could occur due to a bug on Google's side of Apps Script execution that involves multiple accounts being signed in.
  function onSetPropertiesFailure(error)
  {
    //Log an error to the console.
    console.error(error.message + "\n" + error.stack);
    /*google.script.run.openErrorModal("Settings Error", 
      "There was an error updating user settings. This is most often due to multiple accounts being signed in (more info <a href='https://github.com/Synthoid/ExportSheetData#install'>here</a>).", 
      error.message + "\n" + error.stack);*/
  }
  
  //Actually sets the local properties based on stored settings.
  function updateProperties(properties)
  {
    var settings;
    
    if(properties == null || properties === "")
    {
      settings = {};
    }
    else
    {
      settings = JSON.parse(properties);
    }
    
    //Format
    exportType = settings["exportType"] != null ? settings["exportType"] : exportType;
    exportFolderType = settings["exportFolderType"] != null ? settings["exportFolderType"] : exportFolderType;
    exportFolder = settings["exportFolder"] != null ? settings["exportFolder"] : exportFolder;
    exportSheets = settings["exportSheets"] != null ? (settings["exportSheets"] === "" ? exportSheets : settings["exportSheets"]) : exportSheets;
    targetSheets = settings["targetSheets"] != null ? (settings["targetSheets"] === "" ? targetSheets : JSON.parse(settings["targetSheets"])) : targetSheets;
    
    //General
    replaceExistingFiles = settings["replaceExistingFiles"] != null ? settings["replaceExistingFiles"] === true : false;
    unwrapSingleRows = settings["unwrapSingleRows"] != null ? settings["unwrapSingleRows"] === true : false;
    collapseSingleRows = settings["collapseSingleRows"] != null ? settings["collapseSingleRows"] === true : false;
    ignoreEmptyCells = settings["ignoreEmptyCells"] != null ? settings["ignoreEmptyCells"] === true : false;
    
    //Advanced
    nestedElements = settings["nestedElements"] != null ? settings["nestedElements"] === true : false;
    minifyData = settings["minifyData"] != null ? settings["minifyData"] === true : minifyData;
    includeFirstColumn = settings["includeFirstColumn"] != null ? settings["includeFirstColumn"] === true : includeFirstColumn;
    ignoreColumnsWithPrefix = settings["ignoreColumnsWithPrefix"] != null ? settings["ignoreColumnsWithPrefix"] === true : false;
    ignoreColumnsPrefix = settings["ignorePrefix"] != null ? (settings["ignorePrefix"] === "" ? IGNORE_COLUMN_DEFAULT : settings["ignorePrefix"]) : IGNORE_COLUMN_DEFAULT;
    unwrapSheetsWithPrefix = settings["unwrapSheetsWithPrefix"] != null ? settings["unwrapSheetsWithPrefix"] === true : false;
    unwrapSheetsPrefix = settings["unwrapPrefix"] != null ? (settings["unwrapPrefix"] === "" ? UNWRAP_SHEETS_DEFAULT : settings["unwrapPrefix"]) : UNWRAP_SHEETS_DEFAULT;
    collapseSheetsWithPrefix = settings["collapseSheetsWithPrefix"] != null ? settings["collapseSheetsWithPrefix"] === true : false;
    collapseSheetsPrefix = settings["collapsePrefix"] != null ? (settings["collapsePrefix"] === "" ? COLLAPSE_SHEET_DEFAULT : settings["collapsePrefix"]) : COLLAPSE_SHEET_DEFAULT;
    
    //JSON
    exportContentsAsArrayJson = settings["exportContentsAsArray"] != null ? settings["exportContentsAsArray"] === true : exportContentsAsArrayJson;
    exportCellObjectJson = settings["exportCellObject"] != null ? settings["exportCellObject"] === true : exportCellObjectJson;
    exportCellArrayJson = settings["exportCellArray"] != null ? settings["exportCellArray"] === true : exportCellArrayJson;
    exportSheetArrayJson = settings["exportSheetArray"] != null ? settings["exportSheetArray"] === true : exportSheetArrayJson;
    exportValueArrayJson = settings["exportValueArray"] != null ? settings["exportValueArray"] === true : exportValueArrayJson;
    forceStringJson = settings["forceString"] != null ? settings["forceString"] === true : forceStringJson;
    emptyValueFormatJson = settings["emptyValueFormat"] != null ? (settings["emptyValueFormat"] === "" ? emptyValueFormatJson : settings["emptyValueFormat"]) : emptyValueFormatJson;
    nullValueFormatJson = settings["nullValueFormat"] != null ? (settings["nullValueFormat"] === "" ? nullValueFormatJson : settings["nullValueFormat"]) : nullValueFormatJson;
    arraySeparatorCharJson = settings["separatorChar"] != null ? (settings["separatorChar"] === "" ? "," : settings["separatorChar"]) : JSON_SEPARATOR_DEFAULT;
    forceArrayJson = settings["forceArray"] != null ? settings["forceArray"] === true : forceArrayJson;
    forceArrayPrefixJson = settings["forceArrayPrefix"] != null ? (settings["forceArrayPrefix"] === "" ? JSON_JA_DEFAULT : settings["forceArrayPrefix"]) : JSON_JA_DEFAULT;
    forceArrayNest = settings["forceArrayNest"] != null ? settings["forceArrayNest"] === true : forceArrayNest;
    forceArrayPrefixNest = settings["forceArrayPrefixNest"] != null ? (settings["forceArrayPrefixNest"] === "" ? NEST_NA_DEFAULT : settings["forceArrayPrefixNest"]) : NEST_NA_DEFAULT;
    
    //XML
    exportChildElementXml = settings["exportChildElements"] != null ? settings["exportChildElements"] === true : exportChildElementXml;
    exportBoolsAsIntsXml = settings["exportBoolsAsInts"] != null ? settings["exportBoolsAsInts"] === true : exportBoolsAsIntsXml;
    rootElementXml = settings["rootElement"] != null ? (settings["rootElement"] === "" ? rootElementXml : settings["rootElement"]) : rootElementXml;
    //Advanced XML
    nameReplacementCharXml = settings["nameReplacementChar"] != null ? (settings["nameReplacementChar"] === "" ? nameReplacementCharXml : settings["nameReplacementChar"]) : nameReplacementCharXml;
    includeDeclarationXml = settings["includeDeclaration"] != null ? settings["includeDeclaration"] === true : includeDeclarationXml;
    declarationVersionXml = settings["declarationVersion"] != null ? (settings["declarationVersion"] === "" ? declarationVersionXml : settings["declarationVersion"]) : declarationVersionXml;
    declarationEncodingXml = settings["declarationEncoding"] != null ? (settings["declarationEncoding"] === "" ? declarationEncodingXml : settings["declarationEncoding"]) : declarationEncodingXml;
    declarationStandaloneXml = settings["declarationStandalone"] != null ? (settings["declarationStandalone"] === "" ? declarationStandaloneXml : settings["declarationStandalone"]) : declarationStandaloneXml;
    forceAttributesXml = settings["forceAttributes"] != null ? settings["forceAttributes"] === true : forceAttributesXml;
    forceAttributesPrefixXml = settings["attributePrefix"] != null ? (settings["attributePrefix"] === "" ? forceAttributesPrefixXml : settings["attributePrefix"]) : forceAttributesPrefixXml;
    forceChildElementsXml = settings["forceChildElements"] != null ? settings["forceChildElements"] === true : forceChildElementsXml;
    forceChildElementsPrefixXml = settings["childElementPrefix"] != null ? (settings["childElementPrefix"] === "" ? forceChildElementsPrefixXml : settings["childElementPrefix"]) : forceChildElementsPrefixXml;
    forceInnerTextXml = settings["forceInnerText"] != null ? settings["forceInnerText"] === true : forceInnerTextXml;
    forceInnerTextPrefixXml = settings["innerTextPrefix"] != null ? (settings["innerTextPrefix"] === "" ? forceInnerTextPrefixXml : settings["innerTextPrefix"]) : forceInnerTextPrefixXml;
    
    refreshSideBar();
  }
  
  //Generate the JSON blob representation of the document's settings.
  function generateProperties()
  {
    var properties = {
      //Format settings
      "exportType" : exportType,
      "exportFolderType" : exportFolderType,
      "exportFolder" : exportFolder,
      "exportSheets" : exportSheets,
      "targetSheets" : JSON.stringify(targetSheets),
      //General settings
      "replaceExistingFiles" : replaceExistingFiles,
      "unwrapSingleRows" : unwrapSingleRows,
      "collapseSingleRows" : collapseSingleRows,
      "ignoreEmptyCells" : ignoreEmptyCells,
      //Advanced
      "ignoreColumnsWithPrefix" : ignoreColumnsWithPrefix,
      "minifyData" : minifyData,
      "includeFirstColumn" : includeFirstColumn,
      "ignorePrefix" : (ignoreColumnsPrefix === "" ? IGNORE_COLUMN_DEFAULT : ignoreColumnsPrefix),
      "unwrapSheetsWithPrefix" : unwrapSheetsWithPrefix,
      "unwrapPrefix" : (unwrapSheetsPrefix === "" ? UNWRAP_SHEETS_DEFAULT : unwrapSheetsPrefix),
      "collapseSheetsWithPrefix" : collapseSheetsWithPrefix,
      "collapsePrefix" : (collapseSheetsPrefix === "" ? COLLAPSE_SHEET_DEFAULT : collapseSheetsPrefix),
      //Nested Elements
      "nestedElements" : nestedElements,
      "forceArrayNest" : forceArrayNest,
      "forceArrayPrefixNest" : (forceArrayPrefixNest === "" ? NEST_NA_DEFAULT : forceArrayPrefixNest),
      //JSON
      "forceString" : forceStringJson,
      "exportCellArray" : exportCellArrayJson,
      "exportSheetArray" : exportSheetArrayJson,
      "exportValueArray" : exportValueArrayJson,
      //Advanced
      "exportContentsAsArray" : exportContentsAsArrayJson,
      "exportCellObject" : exportCellObjectJson,
      "emptyValueFormat" : emptyValueFormatJson,
      "nullValueFormat" : nullValueFormatJson,
      "separatorChar" : getSeparatorCharJson(),
      "forceArray" : forceArrayJson,
      "forceArrayPrefix" : (forceArrayPrefixJson === "" ? JSON_JA_DEFAULT : forceArrayPrefixJson),
      //XML
      "exportChildElements" : exportChildElementXml,
      "exportBoolsAsInts" : exportBoolsAsIntsXml,
      "rootElement" : getRootElement(),
      //Advanced
      "nameReplacementChar" : nameReplacementCharXml,
      "includeDeclaration" : includeDeclarationXml,
      "declarationVersion" : declarationVersionXml,
      "declarationEncoding" : declarationEncodingXml,
      "declarationStandalone" : declarationStandaloneXml,
      "forceAttributes" : forceAttributesXml,
      "attributePrefix" : (forceAttributesPrefixXml === "" ? XML_ATT_DEFAULT : forceAttributesPrefixXml),
      "forceChildElements" : forceChildElementsXml,
      "childElementPrefix" : (forceChildElementsPrefixXml === "" ? XML_CE_DEFAULT : forceChildElementsPrefixXml),
      "forceInnerText" : forceInnerTextXml,
      "innerTextPrefix" : (forceInnerTextPrefixXml === "" ? XML_IT_DEFAULT : forceInnerTextPrefixXml)
    };
    
    return JSON.stringify(properties);
  }
  
  //Get the names of all sheets in the current document
  function getNames(onSuccess)
  {
    return google.script.run.withSuccessHandler(onSuccess).getSheetNames();
  }
  
  //Get the name of the active sheet in the current document
  function getActiveName(onSuccess)
  {
    return google.script.run.withSuccessHandler(onSuccess).getActiveSheetName();
  }
  
  //Get the name of the target export folder, based on its ID
  function getExportFolderName(onSuccess)
  {
    return google.script.run.withSuccessHandler(onSuccess).getFolderNameFromId(exportFolder);
  }
  
  //Sets the value of the export folder name text input to the returned folder name
  function onGetExportFolderName(name)
  {
    document.getElementById("exportFolderName").value = name;
  }
  
  //Checks if all the sheets are selected for export
  function checkAllTogglesTrue()
  {
    for(var i=0; i < sheets.length; i++)
    {
      if(targetSheets[sheets[i]] === 'false') return false;
    }
    
    return true;
  }
  
  //Open a file explorer to select a custom export folder.
  function openFolderPicker()
  {
    return google.script.run.openFolderPicker();
  }
  
  //General Options
  function toggleReplace()
  {
    replaceExistingFiles = !replaceExistingFiles;
  }
  
  function toggleUnwrapSingleRows()
  {
    unwrapSingleRows = !unwrapSingleRows;
  }
  
  function toggleCollapseSingleRows()
  {
    collapseSingleRows = !collapseSingleRows;
  }
  
  function toggleIgnoreEmptyCells()
  {
    ignoreEmptyCells = !ignoreEmptyCells;
  }
  
  function toggleNestedElements()
  {
    nestedElements = !nestedElements;
  }
  
  function toggleMinifyData()
  {
      minifyData = !minifyData;
  }
  
  function toggleIncludeFirstColumn()
  {
    includeFirstColumn = !includeFirstColumn;
  }
  
  function getIgnorePrefix()
  {
    if(ignoreColumnsWithPrefix === false) return "";
  
    return ignoreColumnsPrefix === "" ? IGNORE_COLUMN_DEFAULT : ignoreColumnsPrefix;
  }
  
  function updateIgnorePrefix()
  {
    ignoreColumnsPrefix = document.getElementById("ignoreColumnsPrefixTextField").value;
  }
  
  function toggleIgnoreColumnsWithPrefix()
  {
    ignoreColumnsWithPrefix = !ignoreColumnsWithPrefix;
    
    var text = "<input id='ignoreColumnsPrefixTextField' type='text' value=";
    text += "'" + ignoreColumnsPrefix + "'";
    text += " placeholder='" + IGNORE_COLUMN_DEFAULT + "'";
    if(ignoreColumnsWithPrefix === false) text += " disabled";
    text += "/>";
    
    document.getElementById("ignoreColumnsText").innerHTML = text;
    
    if(ignoreColumnsWithPrefix === true) document.getElementById('ignoreColumnsPrefixTextField').addEventListener("change", updateIgnorePrefix);
  }
  
  function getUnwrapPrefix()
  {
    if(unwrapSheetsWithPrefix === false) return "";
  
    return unwrapSheetsPrefix === "" ? UNWRAP_SHEETS_DEFAULT : unwrapSheetsPrefix;
  }
  
  function updateUnwrapPrefix()
  {
    unwrapSheetsPrefix = document.getElementById("unwrapSheetsPrefixTextField").value;
  }
  
  function toggleUnwrapSheetsWithPrefix()
  {
    unwrapSheetsWithPrefix = !unwrapSheetsWithPrefix;
    
    var text = "<input id='unwrapSheetsPrefixTextField' type='text' value=";
    text += "'" + unwrapSheetsPrefix + "'";
    text += " placeholder='" + UNWRAP_SHEETS_DEFAULT + "'";
    if(unwrapSheetsWithPrefix === false) text += " disabled";
    text += "/>";
    
    document.getElementById("unwrapSheetsText").innerHTML = text;
    
    if(unwrapSheetsWithPrefix === true) document.getElementById('unwrapSheetsPrefixTextField').addEventListener("change", updateUnwrapPrefix);
  }
  
  function getCollapsePrefix()
  {
    if(collapseSheetsWithPrefix === false) return "";
  
    return collapseSheetsPrefix === "" ? COLLAPSE_SHEET_DEFAULT : collapseSheetsPrefix;
  }
  
  function updateCollapsePrefix()
  {
    collapseSheetsPrefix = document.getElementById("collapseSheetsPrefixTextField").value;
  }
  
  function toggleCollapseSheetsWithPrefix()
  {
    collapseSheetsWithPrefix = !collapseSheetsWithPrefix;
    
    var text = "<input id='collapseSheetsPrefixTextField' type='text' value=";
    text += "'" + collapseSheetsPrefix + "'";
    text += " placeholder='" + COLLAPSE_SHEET_DEFAULT + "'";
    if(collapseSheetsWithPrefix === false) text += " disabled";
    text += "/>";
    
    document.getElementById("collapseSheetsText").innerHTML = text;
    
    if(collapseSheetsWithPrefix === true) document.getElementById('collapseSheetsPrefixTextField').addEventListener("change", updateCollapsePrefix);
  }
  
  //XML Options
  function toggleElement()
  {
    exportChildElementXml = !exportChildElementXml;
  }
  
  function toggleExportBoolsAsInts()
  {
    exportBoolsAsIntsXml = !exportBoolsAsIntsXml;
  }
  
  function getRootElement()
  {
    return rootElementXml === "" ? XML_ROOT_DEFAULT : rootElementXml;
  }
  
  function getDeclarationVersion()
  {
    if(includeDeclarationXml === false) return "";
    
    return declarationVersionXml;
  }
  
  function getDeclarationEncoding()
  {
    if(includeDeclarationXml === false) return "";
    
    return declarationEncodingXml === "none" ? "" : declarationEncodingXml;
  }
  
  function getDeclarationStandalone()
  {
    if(includeDeclarationXml === false) return "";
    
    return declarationStandaloneXml === "none" ? "" : declarationStandaloneXml;
  }
  
  function getAttributePrefix()
  {
    if(forceAttributesXml === false) return "";
  
    return forceAttributesPrefixXml === "" ? XML_ATT_DEFAULT : forceAttributesPrefixXml;
  }
  
  function getChildElementPrefix()
  {
    if(forceChildElementsXml === false) return "";
  
    return forceChildElementsPrefixXml === "" ? XML_CE_DEFAULT : forceChildElementsPrefixXml;
  }
  
  function getInnerTextPrefix()
  {
    if(forceInnerTextXml === false) return "";
    
    return forceInnerTextPrefixXml === "" ? XML_IT_DEFAULT : forceInnerTextPrefixXml;
  }
  
  function updateRootElementXml()
  {
    rootElementXml = document.getElementById("xmlRootField").value;
  }
  
  function updateAttributePrefixXml()
  {
    forceAttributesPrefixXml = document.getElementById("xmlForceAttributesTextField").value;
  }
  
  function updateChildElementPrefixXml()
  {
    forceChildElementsPrefixXml = document.getElementById("xmlForceChildElementsTextField").value;
  }
  
  function updateInnerTextPrefixXml()
  {
    forceInnerTextPrefixXml = document.getElementById("xmlForceInnerTextTextField").value;
  }
  
  //Changes replacement char used in XML elements with illegal characters
  function changeNameReplacementCharXml()
  {
    nameReplacementCharXml = document.getElementById("xmlNameReplaceCharDropdown").value;
  }
  
  function toggleIncludeDeclarationXml()
  {
    includeDeclarationXml = !includeDeclarationXml;
    
    if(document.getElementById('xmlIncludeDeclarationToggle') != null)
    {
      document.getElementById('xmlDeclarationVersionDropdown').removeEventListener("change", changeDeclarationVersionXml);
      document.getElementById('xmlDeclarationEncodingDropdown').removeEventListener("change", changeDeclarationEncodingXml);
      document.getElementById('xmlDeclarationStandaloneDropdown').removeEventListener("change", changeDeclarationStandaloneXml);
    }
    
    var advancedXmlText = "";
    
    //Declaration Version
    advancedXmlText += "<div class='sectionWrapper'><div class='option'><label for='select'>XML version</label><div class='tooltip note'>Version of the XML standard that the XML document conforms to.</div></div><select class='dropdown' id='xmlDeclarationVersionDropdown' onchange='changeDeclarationVersionXml()'";
    if(includeDeclarationXml === false) advancedXmlText += " disabled";
    advancedXmlText += "><option value='1.0'";
    if(declarationVersionXml === "1.0") advancedXmlText += " selected";
    advancedXmlText += ">1.0</option><option value='1.1'";
    if(declarationVersionXml === "1.1") advancedXmlText += " selected";
    advancedXmlText += ">1.1</option></select></div>";
    //Declaration Encoding
    advancedXmlText += "<div class='sectionWrapper'><div class='option'><label for='select'>XML encoding</label><div class='tooltip note'>Identifies which encoding is used to represent the characters in the document.</div></div><select class='dropdown' id='xmlDeclarationEncodingDropdown' onchange='changeDeclarationEncodingXml()'";
    if(includeDeclarationXml === false) advancedXmlText += " disabled";
    advancedXmlText += "><option value='none'";
    if(declarationEncodingXml === "none") advancedXmlText += " selected";
    advancedXmlText += ">None</option><option value='UTF-8'";
    if(declarationEncodingXml === "UTF-8") advancedXmlText += " selected";
    advancedXmlText += ">UTF-8</option><option value='UTF-16'";
    if(declarationEncodingXml === "UTF-16") advancedXmlText += " selected";
    advancedXmlText += ">UTF-16</option><option value='ISO-10646-UCS-2'";
    if(declarationEncodingXml === "ISO-10646-UCS-2") advancedXmlText += " selected";
    advancedXmlText += ">ISO-10646-UCS-2</option><option value='ISO-10646-UCS-4'";
    if(declarationEncodingXml === "ISO-10646-UCS-4") advancedXmlText += " selected";
    advancedXmlText += ">ISO-10646-UCS-4</option><option value='ISO-8859-1'";
    if(declarationEncodingXml === "ISO-8859-1") advancedXmlText += " selected";
    advancedXmlText += ">ISO-8859-1</option><option value='ISO-8859-2'";
    if(declarationEncodingXml === "ISO-8859-2") advancedXmlText += " selected";
    advancedXmlText += ">ISO-8859-2</option><option value='ISO-8859-3'";
    if(declarationEncodingXml === "ISO-8859-3") advancedXmlText += " selected";
    advancedXmlText += ">ISO-8859-3</option><option value='ISO-8859-4'";
    if(declarationEncodingXml === "ISO-8859-4") advancedXmlText += " selected";
    advancedXmlText += ">ISO-8859-4</option><option value='ISO-8859-5'";
    if(declarationEncodingXml === "ISO-8859-5") advancedXmlText += " selected";
    advancedXmlText += ">ISO-8859-5</option><option value='ISO-8859-6'";
    if(declarationEncodingXml === "ISO-8859-6") advancedXmlText += " selected";
    advancedXmlText += ">ISO-8859-6</option><option value='ISO-8859-7'";
    if(declarationEncodingXml === "ISO-8859-7") advancedXmlText += " selected";
    advancedXmlText += ">ISO-8859-7</option><option value='ISO-8859-8'";
    if(declarationEncodingXml === "ISO-8859-8") advancedXmlText += " selected";
    advancedXmlText += ">ISO-8859-8</option><option value='ISO-8859-9'";
    if(declarationEncodingXml === "ISO-8859-9") advancedXmlText += " selected";
    advancedXmlText += ">ISO-8859-9</option><option value='ISO-2022-JP'";
    if(declarationEncodingXml === "ISO-2022-JP") advancedXmlText += " selected";
    advancedXmlText += ">ISO-2022-JP</option><option value='Shift_JIS'";
    if(declarationEncodingXml === "Shift_JIS") advancedXmlText += " selected";
    advancedXmlText += ">Shift_JIS</option><option value='EUC-JP'";
    if(declarationEncodingXml === "EUC-JP") advancedXmlText += " selected";
    advancedXmlText += ">EUC-JP</option></select></div>";
    //Declaration Standalone
    advancedXmlText += "<div class='sectionWrapper'><div class='option'><label for='select'>Standalone</label><div class='tooltip note'>Indicates whether a document relies on information from an external source, such as external document type definition (DTD).</div></div><select class='dropdown' id='xmlDeclarationStandaloneDropdown' onchange='changeDeclarationStandaloneXml()'";
    if(includeDeclarationXml === false) advancedXmlText += " disabled";
    advancedXmlText += "><option value='none'";
    if(declarationStandaloneXml === "none") advancedXmlText += " selected";
    advancedXmlText += ">None</option><option value='yes'";
    if(declarationStandaloneXml === "yes") advancedXmlText += " selected";
    advancedXmlText += ">Yes</option><option value='no'";
    if(declarationStandaloneXml === "no") advancedXmlText += " selected";
    advancedXmlText += ">No</option></select></div>";
    
    document.getElementById("xmlDeclarationSection").innerHTML = advancedXmlText;
    
    if(includeDeclarationXml === true)
    {
      document.getElementById('xmlDeclarationVersionDropdown').addEventListener("change", changeDeclarationVersionXml);
      document.getElementById('xmlDeclarationEncodingDropdown').addEventListener("change", changeDeclarationEncodingXml);
      document.getElementById('xmlDeclarationStandaloneDropdown').addEventListener("change", changeDeclarationStandaloneXml);
    }
  }
  
  function changeDeclarationVersionXml()
  {
    declarationVersionXml = document.getElementById("xmlDeclarationVersionDropdown").value;
  }
  
  function changeDeclarationEncodingXml()
  {
    declarationEncodingXml = document.getElementById("xmlDeclarationEncodingDropdown").value;
  }
  
  function changeDeclarationStandaloneXml()
  {
    declarationStandaloneXml = document.getElementById("xmlDeclarationStandaloneDropdown").value;
  }
  
  function toggleAttributePrefixXml()
  {
    forceAttributesXml = !forceAttributesXml;
    
    var text = "<input id='xmlForceAttributesTextField' type='text' value=";
    text += "'" + forceAttributesPrefixXml + "'";
    text += " placeholder='" + XML_ATT_DEFAULT + "'";
    if(forceAttributesXml === false) text += " disabled";
    text += "/>";
    
    document.getElementById("xmlForceAttributeText").innerHTML = text;
    
    if(forceAttributesXml === true) document.getElementById('xmlForceAttributesTextField').addEventListener("change", updateAttributePrefixXml);
  }
  
  function toggleChildElementPrefixXml()
  {
    forceChildElementsXml = !forceChildElementsXml;
    
    var text = "<input id='xmlForceChildElementsTextField' type='text' value=";
    text += "'" + forceChildElementsPrefixXml + "'";
    text += " placeholder='" + XML_CE_DEFAULT + "'";
    if(forceChildElementsXml === false) text += " disabled";
    text += "/>";
    
    document.getElementById("xmlForceChildElementsText").innerHTML = text;
    
    if(forceChildElementsXml === true) document.getElementById('xmlForceChildElementsTextField').addEventListener("change", updateChildElementPrefixXml);
  }
  
  function toggleInnerTextPrefixXml()
  {
    forceInnerTextXml = !forceInnerTextXml;
    
    var text = "<input id='xmlForceInnerTextTextField' type='text' value=";
    text += "'" + forceInnerTextPrefixXml + "'";
    text += " placeholder='" + XML_IT_DEFAULT + "'";
    if(forceInnerTextXml === false) text += " disabled";
    text += "/>";
    
    document.getElementById("xmlForceInnerTextText").innerHTML = text;
    
    if(forceInnerTextXml === true) document.getElementById('xmlForceInnerTextTextField').addEventListener("change", updateInnerTextPrefixXml);
  }
  
  //JSON Options
  function toggleContentArrayJson()
  {
    exportContentsAsArrayJson = !exportContentsAsArrayJson;
  }
  
  function toggleCellObjectJson()
  {
    exportCellObjectJson = !exportCellObjectJson;
  }
  
  function toggleArrayJson()
  {
    exportCellArrayJson = !exportCellArrayJson;
  }
  
  function toggleSheetArrayJson()
  {
    exportSheetArrayJson = !exportSheetArrayJson;
  }
  
  function toggleValueArrayJson()
  {
    exportValueArrayJson = !exportValueArrayJson;
  }
  
  function toggleForceStringJson()
  {
    forceStringJson = !forceStringJson;
  }
  
  function getSeparatorCharJson()
  {
    return (arraySeparatorCharJson === "" || arraySeparatorCharJson === "'" || arraySeparatorCharJson === '"') ? JSON_SEPARATOR_DEFAULT : arraySeparatorCharJson;
  }
  
  function getForceArrayPrefixJson()
  {
    if(forceArrayJson === false) return "";
  
    return forceArrayPrefixJson === "" ? JSON_JA_DEFAULT : forceArrayPrefixJson;
  }
  
  //Change the exported value for empty cells
  function changeEmptyValueFormatJson()
  {
    emptyValueFormatJson = document.getElementById("jsonEmptyValueFormatDropdown").value;
  }
  
  //Change the exported value for cells containing a string value of "null"
  function changeNullValueFormatJson()
  {
    nullValueFormatJson = document.getElementById("jsonNullValueFormatDropdown").value;
  }
  
  function updateSeparatorCharJson()
  {
    arraySeparatorCharJson = document.getElementById("jsonArraySeparatorCharTextField").value;
  }
  
  function toggleArrayPrefixJson()
  {
    forceArrayJson = !forceArrayJson;
    
    var text = "<input id='jsonForceArrayTextField' type='text' value=";
    text += "'" + forceArrayPrefixJson + "'";
    text += " placeholder='" + JSON_JA_DEFAULT + "'";
    if(forceArrayJson === false) text += " disabled";
    text += "/>";
    
    document.getElementById("jsonForceArrayText").innerHTML = text;
    
    if(forceArrayJson === true) document.getElementById('jsonForceArrayTextField').addEventListener("change", updateArrayPrefixJson);
  }
  
  function updateArrayPrefixJson()
  {
    forceArrayPrefixJson = document.getElementById("jsonForceArrayTextField").value;
  }
  
  //Nested Elements options
  function toggleArrayPrefixNest()
  {
    forceArrayNest = !forceArrayNest;
    
    var text = "<input id='nestForceArrayTextField' type='text' value=";
    text += "'" + forceArrayPrefixNest + "'";
    text += " placeholder='" + NEST_NA_DEFAULT + "'";
    if(forceArrayNest === false) text += " disabled";
    text += "/>";
    
    document.getElementById("nestForceArrayText").innerHTML = text;
    
    if(forceArrayNest === true) document.getElementById('nestForceArrayTextField').addEventListener("change", updateArrayPrefixNest);
  }
  
  function updateArrayPrefixNest()
  {
    forceArrayPrefixNest = document.getElementById("nestForceArrayTextField").value;
  }
  
  function getForceArrayPrefixNest()
  {
    if(forceArrayNest === false) return "";
  
    return forceArrayPrefixNest === "" ? NEST_NA_DEFAULT : forceArrayPrefixNest;
  }
  
  //Toggles value for exporting all sheets
  function toggleAllSheets()
  {
    var value = document.getElementById('allSheetsToggle').value;
    
    if(value === 'false') generateSheetToggles(sheets, true);
    else generateSheetToggles(sheets, false);
  }
  
  //Updates the toggle for all sheets so that it is only checked when all sheets are set for export
  function updateAllSheetsToggle()
  {
    var value = checkAllTogglesTrue();
    
    if(value === true)
    {
      document.getElementById('allToggleContainer').innerHTML = "<input id='allSheetsToggle' type='checkbox' value='true' onChange='toggleAllSheets()' checked /> All";
    }
    else
    {
      document.getElementById('allToggleContainer').innerHTML = "<input id='allSheetsToggle' type='checkbox' value='false' onChange='toggleAllSheets()' /> All";
    }
  }
  
  //Sets all sheets to be exported
  function selectAllSheets()
  {
    generateSheetToggles(sheets, true);
  }
  
  //Sets no sheets to be exported
  function selectNoneSheets()
  {
    generateSheetToggles(sheets, false);
  }
  
  //Toggles a sheet for export
  function toggleSheet(sheetName)
  {
    var value = document.getElementById(formatSheetName(sheetName) + 'Toggle').value;
    
    if(value === 'false') value = 'true';
    else value = 'false';
    
    targetSheets[sheetName] = value;
    
    document.getElementById(formatSheetName(sheetName) + 'Toggle').value = value;
    
    updateAllSheetsToggle();
  }
  
  //Function to rebuild the sidebar after loading export parameters
  function refreshSideBar()
  {
    removeGeneralListeners();
    
    var generalText = "<div class='accordion active'><h1>Format</h1></div><div class='accordionPanel'>";
    //Export Settings
    //Format
    generalText += "<div class='block form-group sectionWrapper'>";
    generalText += "<p><div class='option'><label for='select'><b>Export Format</b></label></div><select class='dropdown' id='formatSelect'><option value='jsonFormat'";
    if(exportType === "jsonFormat") generalText += " selected";
    generalText += ">JSON</option><option value='xmlFormat'";
    if(exportType !== "jsonFormat") generalText += " selected";
    generalText += ">XML</option></select></p>";
    //Export Folder
    generalText += "<p><div class='option'><label for='select'><b>Export Folder</b></label></div><select class='dropdown' id='folderSelect'><option value='default'";
    if(exportFolderType === "default") generalText += " selected";
    generalText += ">Default</option><option value='custom'";
    if(exportFolderType !== "default") generalText += " selected";
    generalText += ">Custom</option></select></p>";
    //Target export folder
    if(exportFolderType !== "default")
    {
      generalText += "<div>";
      generalText += "<input id='exportFolderName' type='text' size='12' value='' placeholder='Select folder...' disabled /> ";
      generalText += "<button onclick='openFolderPicker()'>Browse</button>"
      generalText += "</div>";
    }
    //Sheets
    generalText += "<p><div class='option'><label for='select'><b>Export Sheet(s)</b></label></div><select class='dropdown' id='sheetSelect'><option value='allSheets'";
    if(exportSheets === "allSheets") generalText += " selected";
    generalText += ">All sheets</option><option value='currentSheet'";
    if(exportSheets === "currentSheet") generalText += " selected";
    generalText += ">Current sheet only</option><option value='custom'";
    if(exportSheets === "custom") generalText += " selected";
    generalText += ">Custom</option></select></p>";
    //Custom Sheets
    generalText += "<div id='customSheetSelect'></div></div>"; //Sheet selection is filled automatically at end of refresh process.
    generalText += "</div>";
    
    //General Options
    generalText += "<div class='accordion active'><h1>General</h1></div><div class='accordionPanel'>";
    //Replace existing files
    generalText += "<div class='sectionWrapper'><input id='replaceToggle' type='checkbox' value='Replace'";
    if(replaceExistingFiles) generalText += " checked";
    generalText += "/><div class='option'>Replace existing file(s)<div class='tooltip note'>Find files in the export folder with the same name as the exported file, replace the contents of the most recently modified one, and trash any remaining files with the same name.</div></div></div>";
    //Unwrap Single Rows
    generalText += "<div class='sectionWrapper'><input id='unwrapSingleRowToggle' type='checkbox' value='false'";
    if(unwrapSingleRows) generalText += " checked";
    generalText += "/><div class='option'>Unwrap single row sheets<div class='tooltip note'>Don't wrap a sheet's contents with a JSON object / XML element if it contains only one row. (not counting keys)</div></div></div>";
    //Collapse Single Rows
    generalText += "<div class='sectionWrapper'><input id='collapseSingleRowToggle' type='checkbox' value='false'";
    if(collapseSingleRows) generalText += " checked";
    generalText += "/><div class='option'>Collapse single row sheets<div class='tooltip note'>Collapse a sheet's contents into a JSON object / XML element if it contains only one row. (not counting keys)</div></div></div>";
    //Ignore empty cells
    generalText += "<div class='sectionWrapper'><input id='ignoreEmptyCellsToggle' type='checkbox' value='false'";
    if(ignoreEmptyCells) generalText += " checked";
    generalText += "/><div class='option'>Ignore empty cells<div class='tooltip note'>Don't export cells that are empty.</div></div></div>";
    generalText += "</div>";
    
    //Advanced General Options
    generalText += "<div class='accordion active'><h1>Advanced</h1></div><div class='accordionPanel'>";
    //Nested Elements
    generalText += "<div class='sectionWrapper'><input id='nestedElementsToggle' type='checkbox' value='false'";
    if(nestedElements) generalText += " checked";
    if(exportType != "jsonFormat") generalText += " disabled";
    generalText += "/><div class='option'>Nested Elements<div class='tooltip note'>Export nested elements by using specific formatting in keys.";
    if(exportType != "jsonFormat") generalText += " XML support in development!";
    generalText += "</div></div></div>";
    //Minify Data
    generalText += "<div class='sectionWrapper'><input id='minifyDataToggle' type='checkbox' value='minifyData'";
    if(minifyData) generalText += " checked";
    generalText += "><div class='option'>Minify data<div class='tooltip note'>Remove human readability formatting from the exported data to produce a smaller file.</div></div></div>";
    //Include first column in export
    generalText += "<div class='sectionWrapper'><input id='firstColumnToggle' type='checkbox' value='false'";
    if(includeFirstColumn) generalText += " checked";
    generalText += "/><div class='option'>Include first column<div class='tooltip note'>Export the first column as a distinct element in addition to using it as the name of each row element.</div></div></div>";
    //Ignore columns prefix
    generalText += "<div class='sectionWrapper'><input id='ignoreColumnsToggle' type='checkbox' value='false'";
    if(ignoreColumnsWithPrefix) generalText += " checked";
    generalText += "/><div class='option'>Ignore prefix<div class='tooltip note'>Don't export columns with keys using the specified prefix, or rows whose first value starts with the specified prefix.</div></div><p id='ignoreColumnsText'><input id='ignoreColumnsPrefixTextField' type='text' value='";
    generalText += ignoreColumnsPrefix === "" ? IGNORE_COLUMN_DEFAULT : ignoreColumnsPrefix;
    generalText += "' placeholder='NOEX_'";
    if(ignoreColumnsWithPrefix === false) generalText += " disabled";
    generalText += "/></p><p class='note'></p></div>";
    //Unwrap sheets prefix
    generalText += "<div class='sectionWrapper'><input id='unwrapSheetsToggle' type='checkbox' value='false'";
    if(unwrapSheetsWithPrefix) generalText += " checked";
    generalText += "/><div class='option'>Unwrap sheet prefix<div class='tooltip note'>Unwrap sheets that use the given prefix.</div></div><p id='unwrapSheetsText'><input id='unwrapSheetsPrefixTextField' type='text' value='";
    generalText += unwrapSheetsPrefix === "" ? UNWRAP_SHEETS_DEFAULT : unwrapSheetsPrefix;
    generalText += "' placeholder='US_'";
    if(unwrapSheetsWithPrefix === false) generalText += " disabled";
    generalText += "/></p><p class='note'></p></div>";
    //Collapse sheets prefix
    generalText += "<div class='sectionWrapper'><input id='collapseSheetsToggle' type='checkbox' value='false'";
    if(collapseSheetsWithPrefix) generalText += " checked";
    generalText += "/><div class='option'>Collapse sheet prefix<div class='tooltip note'>Collapse sheets with only one row that use the given prefix.</div></div><p id='collapseSheetsText'><input id='collapseSheetsPrefixTextField' type='text' value='";
    generalText += collapseSheetsPrefix === "" ? COLLAPSE_SHEETS_DEFAULT : collapseSheetsPrefix;
    generalText += "' placeholder='CS_'";
    if(collapseSheetsWithPrefix === false) generalText += " disabled";
    generalText += "/></p><p class='note'></p></div>";
    generalText += "</div>";
    
    document.getElementById("generalOptions").innerHTML = generalText;
    
    //Listeners
    //Format Settings
    document.getElementById('formatSelect').addEventListener("change", changeExportFormat);
    document.getElementById('folderSelect').addEventListener("change", changeExportFolderFormat);
    document.getElementById('sheetSelect').addEventListener("change", changeExportSheets);
    //General Options
    document.getElementById('replaceToggle').addEventListener("change",toggleReplace);
    document.getElementById('unwrapSingleRowToggle').addEventListener("change",toggleUnwrapSingleRows);
    document.getElementById('collapseSingleRowToggle').addEventListener("change",toggleCollapseSingleRows);
    document.getElementById('ignoreEmptyCellsToggle').addEventListener("change",toggleIgnoreEmptyCells);
    //Advanced
    document.getElementById('nestedElementsToggle').addEventListener("change",toggleNestedElements);
    document.getElementById('minifyDataToggle').addEventListener("change", toggleMinifyData);
    document.getElementById('firstColumnToggle').addEventListener("change", toggleIncludeFirstColumn);
    document.getElementById('ignoreColumnsToggle').addEventListener("change",toggleIgnoreColumnsWithPrefix);
    if(ignoreColumnsWithPrefix === true) document.getElementById('ignoreColumnsPrefixTextField').addEventListener("change", updateIgnorePrefix);
    document.getElementById('unwrapSheetsToggle').addEventListener("change",toggleUnwrapSheetsWithPrefix);
    if(unwrapSheetsWithPrefix === true) document.getElementById('unwrapSheetsPrefixTextField').addEventListener("change", updateUnwrapPrefix);
    document.getElementById('collapseSheetsToggle').addEventListener("change",toggleCollapseSheetsWithPrefix);
    if(collapseSheetsWithPrefix === true) document.getElementById('collapseSheetsPrefixTextField').addEventListener("change", updateCollapsePrefix);
    
    if(exportSheets === "custom") getNames(showSheets);
    
    exportType = document.getElementById("formatSelect").value;
    
    if(exportType != "jsonFormat") //Populate XML options
    {
      removeJsonListeners();
      
      document.getElementById("jsonOptions").innerHTML = "";
      document.getElementById("advancedOptions").innerHTML = "";
      
      removeXmlListeners();
      
      var xmlText = "<div class='accordion active'><h1>XML</h1></div><div class='accordionPanel'>";
      //Export child elements
      xmlText += "<div class='sectionWrapper'><input id='elementToggle' type='checkbox' value='false'";
      if(exportChildElementXml) xmlText += " checked";
      xmlText += "/><div class='option'>Export columns as child elements<div class='tooltip note'>Export a sheet's columns as child elements instead of attributes for each row.</div></div></div>";
      
      
      
      //Export bools as ints
      xmlText += "<div class='sectionWrapper'><input id='exportBoolsAsIntsToggle' type='checkbox' value='false'";
      if(exportBoolsAsIntsXml) xmlText += " checked";
      xmlText += "/><div class='option'>Export bools as ints<div class='tooltip note'>Export [true] and [false] boolean values as [1] and [0] respectively..</div></div></div>";
      
      
      
      //Root element value
      xmlText += "<div class='sectionWrapper'><div class='option'>Root element<div class='tooltip note padded'>Root element for the exported XML document.</div></div><input id='xmlRootField' type='text' value=";
      xmlText += "'" + rootElementXml + "'";
      xmlText += " placeholder='" + XML_ROOT_DEFAULT + "'/></div>";
      xmlText += "</div>";
      
      //Advanced Options
      var advancedXmlText = "<div class='accordion active'><h1>Advanced XML</h1></div><div class='accordionPanel'>";
      //Invalid element name char replacement
      advancedXmlText += "<div class='sectionWrapper'><div class='option'><label for='select'>Name replacement char</label><div class='tooltip note padded'>What character to use when replacing illegal characters in XML element names.</div></div><select class='dropdown' id='xmlNameReplaceCharDropdown' onchange='changeNameReplacementCharXml()'><option value='_'";
      if(nameReplacementCharXml === "_") advancedXmlText += " selected";
      advancedXmlText += ">Underscore ( _ )</option><option value='-'";
      if(nameReplacementCharXml === "-") advancedXmlText += " selected";
      advancedXmlText += ">Dash ( - )</option><option value='.'";
      if(nameReplacementCharXml === ".") advancedXmlText += " selected";
      advancedXmlText += ">Dot ( . )</option></select></div>";
      //Declaration
      advancedXmlText += "<div class='sectionWrapper'><input id='xmlIncludeDeclarationToggle' type='checkbox' value='false'";
      if(includeDeclarationXml === true) advancedXmlText += " checked";
      advancedXmlText += "/><div class='option'>Include XML declaration<div class='tooltip note'>Include a customized XML declaration at the top of exported XML files using the parameters set below.</div></div></div>";
      //Declaration Version
      advancedXmlText += "<div id='xmlDeclarationSection'>";
      advancedXmlText += "<div class='sectionWrapper'><div class='option'><label for='select'>XML version</label><div class='tooltip note padded'>Version of the XML standard that the XML document conforms to.</div></div><select class='dropdown' id='xmlDeclarationVersionDropdown' onchange='changeDeclarationVersionXml()'";
      if(includeDeclarationXml === false) advancedXmlText += " disabled";
      advancedXmlText += "><option value='1.0'";
      if(declarationVersionXml === "1.0") advancedXmlText += " selected";
      advancedXmlText += ">1.0</option><option value='1.1'";
      if(declarationVersionXml === "1.1") advancedXmlText += " selected";
      advancedXmlText += ">1.1</option></select></p></div>";
      //Declaration Encoding
      advancedXmlText += "<div class='sectionWrapper'><div class='option'><label for='select'>XML encoding</label><div class='tooltip note padded'>Identifies which encoding is used to represent the characters in the document.</div></div><select class='dropdown' id='xmlDeclarationEncodingDropdown' onchange='changeDeclarationEncodingXml()'";
      if(includeDeclarationXml === false) advancedXmlText += " disabled";
      advancedXmlText += "><option value='none'";
      if(declarationEncodingXml === "none") advancedXmlText += " selected";
      advancedXmlText += ">None</option><option value='UTF-8'";
      if(declarationEncodingXml === "UTF-8") advancedXmlText += " selected";
      advancedXmlText += ">UTF-8</option><option value='UTF-16'";
      if(declarationEncodingXml === "UTF-16") advancedXmlText += " selected";
      advancedXmlText += ">UTF-16</option><option value='ISO-10646-UCS-2'";
      if(declarationEncodingXml === "ISO-10646-UCS-2") advancedXmlText += " selected";
      advancedXmlText += ">ISO-10646-UCS-2</option><option value='ISO-10646-UCS-4'";
      if(declarationEncodingXml === "ISO-10646-UCS-4") advancedXmlText += " selected";
      advancedXmlText += ">ISO-10646-UCS-4</option><option value='ISO-8859-1'";
      if(declarationEncodingXml === "ISO-8859-1") advancedXmlText += " selected";
      advancedXmlText += ">ISO-8859-1</option><option value='ISO-8859-2'";
      if(declarationEncodingXml === "ISO-8859-2") advancedXmlText += " selected";
      advancedXmlText += ">ISO-8859-2</option><option value='ISO-8859-3'";
      if(declarationEncodingXml === "ISO-8859-3") advancedXmlText += " selected";
      advancedXmlText += ">ISO-8859-3</option><option value='ISO-8859-4'";
      if(declarationEncodingXml === "ISO-8859-4") advancedXmlText += " selected";
      advancedXmlText += ">ISO-8859-4</option><option value='ISO-8859-5'";
      if(declarationEncodingXml === "ISO-8859-5") advancedXmlText += " selected";
      advancedXmlText += ">ISO-8859-5</option><option value='ISO-8859-6'";
      if(declarationEncodingXml === "ISO-8859-6") advancedXmlText += " selected";
      advancedXmlText += ">ISO-8859-6</option><option value='ISO-8859-7'";
      if(declarationEncodingXml === "ISO-8859-7") advancedXmlText += " selected";
      advancedXmlText += ">ISO-8859-7</option><option value='ISO-8859-8'";
      if(declarationEncodingXml === "ISO-8859-8") advancedXmlText += " selected";
      advancedXmlText += ">ISO-8859-8</option><option value='ISO-8859-9'";
      if(declarationEncodingXml === "ISO-8859-9") advancedXmlText += " selected";
      advancedXmlText += ">ISO-8859-9</option><option value='ISO-2022-JP'";
      if(declarationEncodingXml === "ISO-2022-JP") advancedXmlText += " selected";
      advancedXmlText += ">ISO-2022-JP</option><option value='Shift_JIS'";
      if(declarationEncodingXml === "Shift_JIS") advancedXmlText += " selected";
      advancedXmlText += ">Shift_JIS</option><option value='EUC-JP'";
      if(declarationEncodingXml === "EUC-JP") advancedXmlText += " selected";
      advancedXmlText += ">EUC-JP</option></select></div>";
      //Declaration Standalone
      advancedXmlText += "<div class='sectionWrapper'><div class='option'><label for='select'>Standalone</label><div class='tooltip note padded'>Indicates whether a document relies on information from an external source, such as external document type definition (DTD).</div></div><select class='dropdown' id='xmlDeclarationStandaloneDropdown' onchange='changeDeclarationStandaloneXml()'";
      if(includeDeclarationXml === false) advancedXmlText += " disabled";
      advancedXmlText += "><option value='none'";
      if(declarationStandaloneXml === "none") advancedXmlText += " selected";
      advancedXmlText += ">None</option><option value='yes'";
      if(declarationStandaloneXml === "yes") advancedXmlText += " selected";
      advancedXmlText += ">Yes</option><option value='no'";
      if(declarationStandaloneXml === "no") advancedXmlText += " selected";
      advancedXmlText += ">No</option></select></div>";
      advancedXmlText += "</div>";
      //Force attribute column export
      advancedXmlText += "<div class='sectionWrapper'><input id='xmlForceAttributeToggle' type='checkbox' value='false'";
      if(forceAttributesXml === true) advancedXmlText += " checked";
      advancedXmlText += "/><div class='option'>Attributes prefix<div class='tooltip note'>Force columns with keys using the specified prefix to export as attributes.</div></div>";
      advancedXmlText += "<p id='xmlForceAttributeText'><input id='xmlForceAttributesTextField' type='text' value=";
      advancedXmlText += "'" + forceAttributesPrefixXml + "'";
      advancedXmlText += " placeholder='" + XML_ATT_DEFAULT + "'";
      if(forceAttributesXml === false) advancedXmlText += " disabled";
      advancedXmlText += "/></p></div>";
      //Force child element column export
      advancedXmlText += "<div class='sectionWrapper'><input id='xmlForceChildElementToggle' type='checkbox' value='false'";
      if(forceChildElementsXml === true) advancedXmlText += " checked";
      advancedXmlText += "/><div class='option'>Child elements prefix<div class='tooltip note'>Force columns with keys using the specified prefix to export as child elements.</div></div>";
      advancedXmlText += "<p id='xmlForceChildElementsText'><input id='xmlForceChildElementsTextField' type='text' value=";
      advancedXmlText += "'" + forceChildElementsPrefixXml + "'";
      advancedXmlText += " placeholder='" + XML_CE_DEFAULT + "'";
      if(forceChildElementsXml === false) advancedXmlText += " disabled";
      advancedXmlText += "/></p></div>";
      //Force inner text column export
      advancedXmlText += "<div class='sectionWrapper'><input id='xmlForceInnerTextToggle' type='checkbox' value='false'";
      if(forceInnerTextXml === true) advancedXmlText += " checked";
      advancedXmlText += "/><div class='option'>Inner text prefix<div class='tooltip note'>Force columns with keys using the specified prefix to export as inner text of the row element.</div></div>";
      advancedXmlText += "<p id='xmlForceInnerTextText'><input id='xmlForceInnerTextTextField' type='text' value=";
      advancedXmlText += "'" + forceInnerTextPrefixXml + "'";
      advancedXmlText += " placeholder='" + XML_IT_DEFAULT + "'";
      if(forceInnerTextXml === false) advancedXmlText += " disabled";
      advancedXmlText += "/></p></div></div>";
      
      document.getElementById("xmlOptions").innerHTML = xmlText;
      document.getElementById("advancedOptions").innerHTML = advancedXmlText;
      //XML Options
      document.getElementById('elementToggle').addEventListener("change", toggleElement);
      document.getElementById('exportBoolsAsIntsToggle').addEventListener("change", toggleExportBoolsAsInts);
      //Advanced Options
      document.getElementById('xmlRootField').addEventListener("change", updateRootElementXml);
      document.getElementById('xmlNameReplaceCharDropdown').addEventListener("change", changeNameReplacementCharXml);
      document.getElementById('xmlIncludeDeclarationToggle').addEventListener("change", toggleIncludeDeclarationXml);
      document.getElementById('xmlDeclarationVersionDropdown').addEventListener("change", changeDeclarationVersionXml);
      document.getElementById('xmlDeclarationEncodingDropdown').addEventListener("change", changeDeclarationEncodingXml);
      document.getElementById('xmlDeclarationStandaloneDropdown').addEventListener("change", changeDeclarationStandaloneXml);
      document.getElementById('xmlForceAttributeToggle').addEventListener("change", toggleAttributePrefixXml);
      if(forceAttributesXml === true) document.getElementById('xmlForceAttributesTextField').addEventListener("change", updateAttributePrefixXml);
      document.getElementById('xmlForceChildElementToggle').addEventListener("change", toggleChildElementPrefixXml);
      if(forceChildElementsXml === true) document.getElementById('xmlForceChildElementsTextField').addEventListener("change", updateChildElementPrefixXml);
      document.getElementById('xmlForceInnerTextToggle').addEventListener("change", toggleInnerTextPrefixXml);
      if(forceInnerTextXml === true) document.getElementById('xmlForceInnerTextTextField').addEventListener("change", updateInnerTextPrefixXml);
    }
    else //Populate JSON options
    {
      removeXmlListeners();
      document.getElementById("xmlOptions").innerHTML = "";
      document.getElementById("advancedOptions").innerHTML = "";
    
      removeJsonListeners();
      
      //JSON Options
      var jsonText = "<div class='accordion active'><h1>JSON</h1></div><div class='accordionPanel'>";
      //Force string JSON
      jsonText += "<div class='sectionWrapper'><input id='forceStringToggle' type='checkbox' value='Force'";
      if(forceStringJson) jsonText += " checked";
      jsonText += "><div class='option'>Force string values<div class='tooltip note'>Force exported values to be strings.</div></div></div>";
      //Commas to array JSON
      jsonText += "<div class='sectionWrapper'><input id='arrayToggle' type='checkbox' value='Array'";
      if(exportCellArrayJson) jsonText += " checked";
      jsonText += "><div class='option'>Export cell arrays<div class='tooltip note'>Export a cell's contents as a JSON array if it contains commas. (Wrap content in quotation marks to prevent mid-content breaking)</div></div></div>";
      //Sheet to JSON object array
      jsonText += "<div class='sectionWrapper'><input id='sheetArrayToggle' type='checkbox' value='SheetArray'";
      if(exportSheetArrayJson) jsonText += " checked";
      jsonText += "><div class='option'>Export sheet arrays<div class='tooltip note'>Export a sheet's contents as an array of JSON objects.</div></div></div>";
      //Sheet to JSON value array
      jsonText += "<div class='sectionWrapper'><input id='valueArrayToggle' type='checkbox' value='ValueArray'";
      if(exportValueArrayJson) jsonText += " checked";
      jsonText += "><div class='option'>Export value arrays<div class='tooltip note'>Export a sheet's contents as an array of JSON values if it has only one column.</div></div></div></div>";
      
      //Advanced Options
      var advancedJsonText = "<div class='accordion active'><h1>Advanced JSON</h1></div><div class='accordionPanel'>";
      //Content to array JSON
      advancedJsonText += "<div class='sectionWrapper'><input id='contentsArrayToggle' type='checkbox' value='ContentArray'";
      if(exportContentsAsArrayJson) advancedJsonText += " checked";
      advancedJsonText += "><div class='option'>Export contents as array<div class='tooltip note'>Export total contents as a raw JSON array. (WARNING: This means the exported data will not be formatted as a stand-alone JSON object.)</div></div></div>";
      //Braces to object JSON
      advancedJsonText += "<div class='sectionWrapper'><input id='cellObjectToggle' type='checkbox' value='CellObject'";
      if(exportCellObjectJson) advancedJsonText += " checked";
      advancedJsonText += "><div class='option'>Export cell objects<div class='tooltip note'>Export a cell's contents as a JSON object if it is wrapped in braces, or a JSON array if wrapped in brackets. (WARNING: This content will export an empty object/array if not properly formatted.)</div></div></div>";
      //Empty Value Type
      advancedJsonText += "<div class='sectionWrapper'><div class='option'><label for='select'>Empty value format</label><div class='tooltip note padded'>What value to export for empty cells.</div></div><select class='dropdown' id='jsonEmptyValueFormatDropdown' onchange='changeEmptyValueFormatJson()'><option value='null'";
      if(emptyValueFormatJson === "null") advancedJsonText += " selected";
      advancedJsonText += ">Null ( null )</option><option value='string'";
      if(emptyValueFormatJson === "string") advancedJsonText += " selected";
      advancedJsonText += ">Empty String ( &quot;&quot; )</option></select></div>";
      //Null Value Type
      advancedJsonText += "<div class='sectionWrapper'><div class='option'><label for='select'>Null value format</label><div class='tooltip note padded'>What value to export for cells with a string value of &quot;null&quot;.</div></div><select class='dropdown' id='jsonNullValueFormatDropdown' onchange='changeNullValueFormatJson()'><option value='null'";
      if(nullValueFormatJson === "null") advancedJsonText += " selected";
      advancedJsonText += ">Null ( null )</option><option value='string'";
      if(nullValueFormatJson === "string") advancedJsonText += " selected";
      advancedJsonText += ">String ( &quot;null&quot; )</option></select></div>";
      //Separator char value
      advancedJsonText += "<div class='sectionWrapper'><div class='option'>Array separator character<div class='tooltip note padded'>Character used to separate elements when exporting JSON arrays.</div></div><input id='jsonArraySeparatorCharTextField' type='text' maxlength='1' value=";
      advancedJsonText += "'" + arraySeparatorCharJson + "'";
      advancedJsonText += " placeholder='" + JSON_SEPARATOR_DEFAULT + "'";
      advancedJsonText += "/></div>";
      //Force JSON array export
      advancedJsonText += "<div class='sectionWrapper'><input id='jsonForceArrayToggle' type='checkbox' value='false'";
      if(forceArrayJson === true) advancedJsonText += " checked";
      advancedJsonText += "/><div class='option'>Array prefix<div class='tooltip note'>Force sheets or cells in columns with keys using the specified prefix to export as JSON arrays.</div></div>";
      advancedJsonText += "<p id='jsonForceArrayText'><input id='jsonForceArrayTextField' type='text' value=";
      advancedJsonText += "'" + forceArrayPrefixJson + "'";
      advancedJsonText += " placeholder='" + JSON_JA_DEFAULT + "'";
      if(forceArrayJson === false) advancedJsonText += " disabled";
      advancedJsonText += "/></p></div>";
      //Force nested array export
      advancedJsonText += "<div class='sectionWrapper'><input id='nestForceArrayToggle' type='checkbox' value='false'";
      if(forceArrayNest === true) advancedJsonText += " checked";
      advancedJsonText += "/><div class='option'>Nested Array prefix<div class='tooltip note'>Force sheets with names using the specified prefix to export as Nested Element arrays.</div></div>";
      advancedJsonText += "<p id='nestForceArrayText'><input id='nestForceArrayTextField' type='text' value=";
      advancedJsonText += "'" + forceArrayPrefixNest + "'";
      advancedJsonText += " placeholder='" + NEST_NA_DEFAULT + "'";
      if(forceArrayNest === false) advancedJsonText += " disabled";
      advancedJsonText += "/></p></div>";
      advancedJsonText += "</div>";
      
      document.getElementById("jsonOptions").innerHTML = jsonText;
      document.getElementById("advancedOptions").innerHTML = advancedJsonText;
      //JSON Options
      document.getElementById('contentsArrayToggle').addEventListener("change", toggleContentArrayJson);
      document.getElementById('cellObjectToggle').addEventListener("change", toggleCellObjectJson);
      document.getElementById('arrayToggle').addEventListener("change", toggleArrayJson);
      document.getElementById('sheetArrayToggle').addEventListener("change", toggleSheetArrayJson);
      document.getElementById('valueArrayToggle').addEventListener("change", toggleValueArrayJson);
      document.getElementById('forceStringToggle').addEventListener("change", toggleForceStringJson);
      //Advanced Options
      document.getElementById('jsonEmptyValueFormatDropdown').addEventListener("change", changeEmptyValueFormatJson);
      document.getElementById('jsonNullValueFormatDropdown').addEventListener("change", changeNullValueFormatJson);
      document.getElementById('jsonArraySeparatorCharTextField').addEventListener("change", updateSeparatorCharJson);
      document.getElementById('jsonForceArrayToggle').addEventListener("change", toggleArrayPrefixJson);
      if(forceArrayJson === true) document.getElementById('jsonForceArrayTextField').addEventListener("change", updateArrayPrefixJson);
      document.getElementById('nestForceArrayToggle').addEventListener("change", toggleArrayPrefixNest);
      if(forceArrayNest === true) document.getElementById('nestForceArrayTextField').addEventListener("change", updateArrayPrefixNest);
    }
    
    if(exportFolderType !== "default" && exportFolder !== "") getExportFolderName(onGetExportFolderName); //Populate the name of the target export folder
    
    var accordions = document.getElementsByClassName("accordion");
    var i;
    
    for(i=0; i < accordions.length; i++)
    {
      accordions[i].addEventListener("click", function()
      {
        this.classList.toggle("active");
        
        var panel = this.nextElementSibling;
        
        if(panel.style.display === "block" || panel.style.display === "") panel.style.display = "none";
        else panel.style.display = "block";
      });
    }
  }
  
  //Changes export format between XML and JSON
  function changeExportFormat()
  {
    exportType = document.getElementById("formatSelect").value;
    
    refreshSideBar();
  }
  
  //Changes export folder target between default and custom.
  function changeExportFolderFormat()
  {
    exportFolderType = document.getElementById("folderSelect").value;
    
    refreshSideBar();
  }
  
  //Updates the method for selecting sheets for export
  function changeExportSheets()
  {
    exportSheets = document.getElementById("sheetSelect").value;
    
    if(exportSheets != "custom")
    {
      clearSheetToggles();
    }
    else
    {
      getNames(showSheets);
    }
  }
  
  function showSheets(sheetNames)
  {
    sheets = sheetNames;
    
    generateAutoSheetToggles(sheetNames); //TODO: Sheet names are getting culled on load sometimes... (seems to be after all are toggled on then one is toggled off as the off sheet is the only name returned...)
  }
  
  //Formats sheet names so special characters don't break event listeners
  function formatSheetName(sheetName)
  {
    return sheetName.replace(/[^a-zA-Z0-9\-\_]/gm, "_");
  }
  
  //Generates toggle elements determining which sheets should be exported
  function generateAutoSheetToggles(sheetNames)
  {
    var cachedToggles = targetSheets;
    
    clearSheetToggles();
    
    //Check if all sheets are being exported
    var allActive = true;
    
    for(var i=0; i < sheetNames.length; i++)
    {
      if(cachedToggles[sheetNames[i]] == null || cachedToggles[sheetNames[i]] === false || cachedToggles[sheetNames[i]] === 'false')
      {
        allActive = false;
        break;
      }
    }
    
    var text = "<div id='allToggleContainer'><input id='allSheetsToggle' type='checkbox' value='" + allActive + "' onChange='toggleAllSheets()' ";
    
    if(allActive === true) text += "checked ";
    
    text += "/> All</div><hr><div class='scrollWrapper'>";
    
    for(var i=0; i < sheetNames.length; i++)
    {
      text += "<p>";
      
      if(cachedToggles[sheetNames[i]] != null)
      {
        text += "<input id='" + formatSheetName(sheetNames[i]) + "Toggle' type='checkbox' value='true'";
        if(cachedToggles[sheetNames[i]] === 'true' || cachedToggles[sheetNames[i]] === true) text += " checked";
        text += "/> " + sheetNames[i];
        
        targetSheets[sheetNames[i]] = (cachedToggles[sheetNames[i]] === 'true' ? 'true' : 'false');
      }
      else
      {
        text += "<input id='" + formatSheetName(sheetNames[i]) + "Toggle' type='checkbox' value='false'/> " + sheetNames[i];
        targetSheets[sheetNames[i]] = 'false';
      }
      
      text += "</p>";
    }
    
    text += "</div><hr>";
    
    document.getElementById("customSheetSelect").innerHTML = text;
    
    createSheetToggleListeners()
  }
  
  //Generates toggle elements determining which sheets should be exported and sets their export value to be the given default value
  function generateSheetToggles(sheetNames, defaultValue)
  {
    clearSheetToggles();
    
    var text = "<div id='allToggleContainer'><input id='allSheetsToggle' type='checkbox' value='" + defaultValue + "' onChange='toggleAllSheets()' ";
    
    if(defaultValue === true) text += "checked ";
    
    text += "/> All</div><hr><div class='scrollWrapper'>";
    
    for(var i=0; i < sheetNames.length; i++)
    {
      text += "<p>";
      
      if(defaultValue === true)
      {
        text += "<input id='" + formatSheetName(sheetNames[i]) + "Toggle' type='checkbox' value='true' checked /> " + sheetNames[i];
        targetSheets[sheetNames[i]] = 'true';
      }
      else
      {
        text += "<input id='" + formatSheetName(sheetNames[i]) + "Toggle' type='checkbox' value='false' /> " + sheetNames[i];
        targetSheets[sheetNames[i]] = 'false';
      }
      
      text += "</p>";
    }
    
    text += "</div><hr>";
    
    document.getElementById("customSheetSelect").innerHTML = text;
    
    createSheetToggleListeners()
  }
  
  //Creates event listeners for sheet export toggles
  function createSheetToggleListeners()
  {
    for(var i=0; i < sheets.length; i++)
    {
      (function()
      {
        var targetSheet = sheets[i];
        document.getElementById(formatSheetName(targetSheet) + 'Toggle').addEventListener("change", function() { toggleSheet(targetSheet); });
      }())
    }
  }
  
  //Removes event listeners for sheet export toggles
  function clearSheetToggles()
  {
    targetSheets = { };
    
    for(var i=0; i < sheets.length; i++)
    {
      (function()
      {
        if(document.getElementById(formatSheetName(sheets[i]) + 'Toggle') != null)
        {
          var targetSheet = sheets[i];
          document.getElementById(formatSheetName(targetSheet) + 'Toggle').removeEventListener("change", function() { toggleSheet(targetSheet); });
        }
      }())
    }
    
    document.getElementById("customSheetSelect").innerHTML = "";
  }
  
  //Removes event listeners for general option toggles
  function removeGeneralListeners()
  {
    //Basic
    if(document.getElementById('formatSelect') != null)
    {
      document.getElementById('formatSelect').addEventListener("change", changeExportFormat);
    }
    if(document.getElementById('folderSelect') != null)
    {
      document.getElementById('folderSelect').addEventListener("change", changeExportFolderFormat);
    }
    if(document.getElementById('sheetSelect') != null)
    {
      document.getElementById('sheetSelect').addEventListener("change", changeExportSheets);
    }
    if(document.getElementById('replaceToggle') != null)
    {
      document.getElementById('replaceToggle').removeEventListener("change", toggleReplace);
    }
    if(document.getElementById('unwrapSingleRowToggle') != null)
    {
      document.getElementById('unwrapSingleRowToggle').removeEventListener("change", toggleUnwrapSingleRows);
    }
    if(document.getElementById('collapseSingleRowToggle') != null)
    {
      document.getElementById('collapseSingleRowToggle').removeEventListener("change", toggleCollapseSingleRows);
    }
    if(document.getElementById('ignoreEmptyCellsToggle') != null)
    {
      document.getElementById('ignoreEmptyCellsToggle').removeEventListener("change", toggleIgnoreEmptyCells);
    }
    
    //Advanced
    if(document.getElementById('nestedElementsToggle') != null)
    {
      document.getElementById('nestedElementsToggle').removeEventListener("change", toggleNestedElements);
    }
    if(document.getElementById('minifyDataToggle') != null)
    {
      document.getElementById('minifyDataToggle').removeEventListener("change", toggleMinifyData);
    }
    if(document.getElementById('firstColumnToggle') != null)
    {
      document.getElementById('firstColumnToggle').removeEventListener("change", toggleIncludeFirstColumn);
    }
    if(document.getElementById('ignoreColumnsToggle') != null)
    {
      document.getElementById('ignoreColumnsToggle').removeEventListener("change", toggleIgnoreColumnsWithPrefix);
      document.getElementById('ignoreColumnsPrefixTextField').removeEventListener("change", updateIgnorePrefix);
    }
    if(document.getElementById('unwrapSheetsToggle') != null)
    {
      document.getElementById('unwrapSheetsToggle').removeEventListener("change", toggleUnwrapSheetsWithPrefix);
      document.getElementById('unwrapSheetsPrefixTextField').removeEventListener("change", updateUnwrapPrefix);
    }
    if(document.getElementById('collapseSheetsToggle') != null)
    {
      document.getElementById('collapseSheetsToggle').removeEventListener("change", toggleCollapseSheetsWithPrefix);
      document.getElementById('collapseSheetsPrefixTextField').removeEventListener("change", updateCollapsePrefix);
    }
  }
  
  //Removes event listeners for XML option toggles
  function removeXmlListeners()
  {
    if(document.getElementById('elementToggle') != null)
    {
      document.getElementById('elementToggle').removeEventListener("change", toggleElement);
    }
    if(document.getElementById('exportBoolsAsIntsToggle') != null)
    {
      document.getElementById('exportBoolsAsIntsToggle').removeEventListener("change", toggleExportBoolsAsInts);
    }
    if(document.getElementById('xmlRootField') != null)
    {
      document.getElementById('xmlRootField').removeEventListener("change", updateRootElementXml);
    }
    if(document.getElementById('xmlNameReplaceCharDropdown') != null)
    {
      document.getElementById('xmlNameReplaceCharDropdown').removeEventListener("change", changeNameReplacementCharXml);
    }
    
    if(document.getElementById('xmlIncludeDeclarationToggle') != null)
    {
      document.getElementById('xmlIncludeDeclarationToggle').removeEventListener("change", toggleIncludeDeclarationXml);
      document.getElementById('xmlDeclarationVersionDropdown').removeEventListener("change", changeDeclarationVersionXml);
      document.getElementById('xmlDeclarationEncodingDropdown').removeEventListener("change", changeDeclarationEncodingXml);
      document.getElementById('xmlDeclarationStandaloneDropdown').removeEventListener("change", changeDeclarationStandaloneXml);
    }
    
    if(document.getElementById('xmlForceAttributeToggle') != null)
    {
      document.getElementById('xmlForceAttributeToggle').removeEventListener("change", toggleAttributePrefixXml);
      document.getElementById('xmlForceAttributesTextField').removeEventListener("change", updateAttributePrefixXml);
    }
    if(document.getElementById('xmlForceChildElementToggle') != null)
    {
      document.getElementById('xmlForceChildElementToggle').removeEventListener("change", toggleChildElementPrefixXml);
      document.getElementById('xmlForceChildElementsTextField').removeEventListener("change", updateChildElementPrefixXml);
    }
    if(document.getElementById('xmlForceInnerTextToggle') != null)
    {
      document.getElementById('xmlForceInnerTextToggle').removeEventListener("change", toggleInnerTextPrefixXml);
      document.getElementById('xmlForceInnerTextTextField').removeEventListener("change", updateInnerTextPrefixXml);
    }
  }
  
  //Removes event listeners for JSON option toggles
  function removeJsonListeners()
  {
    if(document.getElementById('contentsArrayToggle') != null)
    {
      document.getElementById('contentsArrayToggle').removeEventListener("change", toggleContentArrayJson);
    }
    if(document.getElementById('cellObjectToggle') != null)
    {
      document.getElementById('cellObjectToggle').removeEventListener("change", toggleCellObjectJson);
    }
    if(document.getElementById('arrayToggle') != null)
    {
      document.getElementById('arrayToggle').removeEventListener("change", toggleArrayJson);
    }
    if(document.getElementById('sheetArrayToggle') != null)
    {
      document.getElementById('sheetArrayToggle').removeEventListener("change", toggleSheetArrayJson);
    }
    if(document.getElementById('valueArrayToggle') != null)
    {
      document.getElementById('valueArrayToggle').removeEventListener("change", toggleValueArrayJson);
    }
    if(document.getElementById('forceStringToggle') != null)
    {
      document.getElementById('forceStringToggle').removeEventListener("change", toggleForceStringJson);
    }
    if(document.getElementById('jsonEmptyValueFormatDropdown') != null)
    {
      document.getElementById('jsonEmptyValueFormatDropdown').removeEventListener("change", changeEmptyValueFormatJson);
    }
    if(document.getElementById('jsonNullValueFormatDropdown') != null)
    {
      document.getElementById('jsonNullValueFormatDropdown').removeEventListener("change", changeNullValueFormatJson);
    }
    if(document.getElementById('jsonArraySeparatorCharTextField') != null)
    {
      document.getElementById('jsonArraySeparatorCharTextField').removeEventListener("change", updateSeparatorCharJson);
    }
    if(document.getElementById('jsonForceArrayToggle') != null)
    {
      document.getElementById('jsonForceArrayToggle').removeEventListener("change", toggleArrayPrefixJson);
      document.getElementById('jsonForceArrayTextField').removeEventListener("change", updateArrayPrefixJson);
    }
    if(document.getElementById('nestForceArrayToggle') != null)
    {
      document.getElementById('nestForceArrayToggle').removeEventListener("change", toggleArrayPrefixNest);
      document.getElementById('nestForceArrayTextField').removeEventListener("change", updateArrayPrefixNest);
    }
  }
  
  //Creates a JSON blob representing the current XML settings
  function generateXmlSettings(singleSheet, exportSheets)
  {
    var settings = {
      //Format
      "exportType" : exportType,
      "exportFolderType" : exportFolderType,
      "exportFolder" : exportFolder,
      "visualize" : visualizeData,
      "singleSheet" : singleSheet,
      //General
      "replaceExistingFiles" : replaceExistingFiles,
      "unwrapSingleRows" : unwrapSingleRows,
      "collapseSingleRows" : collapseSingleRows,
      "ignoreEmptyCells" : ignoreEmptyCells,
      //Advanced
      "nestedElements" : nestedElements,
      "minifyData" : minifyData,
      "includeFirstColumn" : includeFirstColumn,
      "ignorePrefix" : getIgnorePrefix(),
      "unwrapPrefix":getUnwrapPrefix(),
      "collapsePrefix":getCollapsePrefix(),
      "targetSheets" : exportSheets,
      //XML
      "exportChildElements" : exportChildElementXml,
      "exportBoolsAsInts" : exportBoolsAsIntsXml,
      "rootElement" : getRootElement(),
      "nameReplacementChar" : nameReplacementCharXml,
      "declarationVersion" : getDeclarationVersion(),
      "declarationEncoding" : getDeclarationEncoding(),
      "declarationStandalone" : getDeclarationStandalone(),
      "attributePrefix" : getAttributePrefix(),
      "childElementPrefix" : getChildElementPrefix(),
      "innerTextPrefix" : getInnerTextPrefix()
    };
    
    return JSON.stringify(settings);
  }
  
  //Creates a JSON blob representing the current XML settings
  function generateJsonSettings(singleSheet, exportSheets)
  {
    var settings = {
      "exportType" : exportType,
      "exportFolderType" : exportFolderType,
      "exportFolder" : exportFolder,
      "visualize" : visualizeData,
      "singleSheet" : singleSheet,
      "replaceExistingFiles" : replaceExistingFiles,
      "unwrapSingleRows" : unwrapSingleRows,
      "collapseSingleRows" : collapseSingleRows,
      "ignoreEmptyCells" : ignoreEmptyCells,
      "nestedElements" : nestedElements,
      "minifyData" : minifyData,
      "includeFirstColumn" : includeFirstColumn,
      "ignorePrefix" : getIgnorePrefix(),
      "unwrapPrefix":getUnwrapPrefix(),
      "collapsePrefix":getCollapsePrefix(),
      "targetSheets" : exportSheets,
      "forceString" : forceStringJson,
      "exportCellArray" : exportCellArrayJson,
      "exportSheetArray" : exportSheetArrayJson,
      "exportValueArray" : exportValueArrayJson,
      "exportContentsAsArray" : exportContentsAsArrayJson,
      "exportCellObject" : exportCellObjectJson,
      "emptyValueFormat" : emptyValueFormatJson,
      "nullValueFormat" : nullValueFormatJson,
      "separatorChar" : getSeparatorCharJson(),
      "forceArrayPrefix" : getForceArrayPrefixJson(),
      "forceArrayPrefixNest" : getForceArrayPrefixNest()
    };
    
    return JSON.stringify(settings);
  }
  
  //Set selected sheets to be visualized with the current options
  function visualizeFile()
  {
    visualizeData = true;
  
    if(exportType === EXP_TYPE_XML) exportXml();
    else exportJson();
    
    setProperties();
  }
  
  //Set selected sheets to be exported with the current options
  function exportFile()
  {
    visualizeData = false;
  
    if(exportType === EXP_TYPE_XML) exportXml();
    else exportJson();
    
    setProperties();
  }
  
  function exportXml()
  {
    if(exportSheets === EXP_SHEET_SINGLE)
    {
      getActiveName(exportXmlSingle);
    }
    else if(exportSheets === EXP_SHEET_CUSTOM)
    {
      google.script.run.exportXml(generateXmlSettings(false, targetSheets));
    }
    else
    {
      google.script.run.exportXml(generateXmlSettings(false, null));
    }
  }
  
  function exportXmlSingle(sheet)
  {
    var newSheets = { };
    newSheets[sheet] = 'true';
    
    google.script.run.exportXml(generateXmlSettings(true, newSheets));
  }
  
  function exportJson()
  {
    if(exportSheets === EXP_SHEET_SINGLE)
    {
      getActiveName(exportJsonSingle);
    }
    else if(exportSheets === EXP_SHEET_CUSTOM)
    {
      google.script.run.exportJson(generateJsonSettings(false, targetSheets));
    }
    else
    {
      google.script.run.exportJson(generateJsonSettings(false, null));
    }
  }
  
  function exportJsonSingle(sheet)
  {
    var newSheets = { };
    newSheets[sheet] = 'true';
    
    google.script.run.exportJson(generateJsonSettings(true, newSheets));
  }
  
  getProperties(updateProperties, onGetPropertiesFailure);
</script>